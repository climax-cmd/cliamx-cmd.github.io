<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巡回セールスマン問題の解法と理論 - climaxのホームページ</title>
    <link rel="stylesheet" href="css/style.css">
    
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          }
        };
    </script>
    <script id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        /* コードブロック用のスタイルを追加 */
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body>
    <header>
        <h1>climaxのホームページ</h1>
    </header>

    <main class="article-content">
        <article>
            <h2>巡回セールスマン問題の解法と理論</h2>

            <h3>巡回セールスマン問題とは？</h3>
            <ul>
                <li>複数の都市が与えられたとき、全ての都市を一度ずつ訪問して出発点に戻ってくる最短の経路を求める問題です。</li>
                <li>計算量が爆発的に増加してしまうことが知られています。</li>
                <li>しかし解決できれば多様な分野で応用が可能です。</li>
            </ul>

            <h3>ヘルドカープのアルゴリズム</h3>
            <ul>
                <li>動的計画法に基づく厳密解法です。</li>
                <li>$C(S, j)$ を「出発都市(例:都市1)から、都市の部分集合 $S$ をすべて経由し、最後に都市 $j \in S$ に到達する最短経路長」と定義します。</li>
                <li>この部分問題は、以下の漸化式によって再帰的に解くことができます。
                    $$ C(S, j) = \min_{k \in S \setminus \{j\}} \{ C(S \setminus \{j\}, k) + d_{kj} \} $$
                </li>
                <li>ここで、$d_{kj}$ は都市kから都市jへの距離を表します。この計算を、集合Sのサイズを1からNまで大きくしながら進めることで、最終的な最適解を構築します。</li>
                <li>計算量は $O(N^2 2^N)$ であり、全探索の $O(N!)$ よりは遥かに効率的ですが、それでもNが20程度を超えると現実的な時間内での計算は困難となります。</li>
            </ul>

            <h3>一部コードの解説</h3>
            <ul>
                <li>アルゴリズムに関しては先ほど説明したとおりですが、実装方法について解説します。</li>
                <li>n個の頂点を回る必要がある場合、その頂点をすでに巡回したかのフラグ(つまり冪集合)と最後に訪問した都市の情報が必要になります。</li>
                <li>冪集合ではi番目のbitが0ならばi番目の頂点は未訪問、1ならば訪問済みとすればよいです。</li>
                <li>スタートを頂点0とし、そのためdp[1][0]=0としています。</li>
                <li>最後の頂点と出発点までをつなぎ $\min_j(\text{dp}[2^n - 1][j] + \text{頂点jから0までの距離})$ が最短経路となります。</li>
            </ul>
            <pre><code>dp[1][0] = 0
for mask in range(1, 1 &lt;&lt; n):
    for j in range(n):
        if (mask &gt;&gt; j) & 1:
            prev_mask = mask ^ (1 &lt;&lt; j)
            if prev_mask == 0: continue
            for k in range(n):
                if (prev_mask &gt;&gt; k) & 1:
                    cost = dp[prev_mask][k] + dist_matrix[k][j]
                    if cost &lt; dp[mask][j]:
                        dp[mask][j] = cost

final_mask = (1 &lt;&lt; n) - 1
min_tour_dist = float('inf')
last_city = -1
for j in range(1, n):
    tour_dist = dp[final_mask][j] + dist_matrix[j][0]
    if tour_dist &lt; min_tour_dist:
        min_tour_dist = tour_dist
        last_city = j
</code></pre>

            <h3>焼きなまし法の紹介</h3>
            <ul>
                <li>常に良い解を選ぶのではなく、「温度」パラメータに応じて確率的に悪い解も許容します。</li>
                <li>一般に離散的に状態空間を持つ組み合わせ最適化問題に対してのアプローチです。</li>
                <li>最初に温度を設定し、徐々に冷やしていきます。</li>
                <li>探索初期(高温): 解が悪化する移動も許容し、広域的に探索します。</li>
                <li>探索終盤(低温): 次第に改善する移動のみを選択し、一つの解に収束させます。</li>
                <li>この方法はマルコフ過程によってモデリングでき大域的最適解が保証できます！(一般にヒューリスティック解法は解の保証がないものが多いです)。</li>
                <li>右の画像では温度と近傍の範囲が依存しているように見えるが、一般的には温度に依存しません。</li>
            </ul>

            <h3>準備(マルコフ連鎖とは)</h3>
            <ul>
                <li>マルコフ過程のうち、状態が離散的(有限的)なものをマルコフ連鎖と呼びます。</li>
                <li>オートマトンと非常に似た構造を持っています！</li>
                <li>違いは遷移が確率によって起こるか、外部入力される文字によって起こるかです。</li>
            </ul>

            <h3>マルコフ連鎖の分類</h3>
            <h4>斉時性と既約性</h4>
            <ul>
                <li><strong>斉時性</strong>: 状態の推移確率が時間に拠らず一定です (焼きなまし法では実際の推移する確率でないことに注意)。</li>
                <li><strong>既約性</strong>: マルコフ連鎖の状態空間の任意の二状態が互いに到達可能です。たとえば吸収状態集合などがあるとダメです(右の図では解約ユーザーの状態になってしまうと脱出できません)。</li>
                <li>状態が互いに到達可能かは同値関係を満たします。そして状態集合はこの同値関係を使って直和分解できます。</li>
            </ul>
            <h4>非周期性</h4>
            <ul>
                <li><strong>非周期性</strong>: n回のステップで頂点iからjに到達できる確率を$P_{ij}^{(n)}$とします。(到達不可なら0)</li>
                <li>状態iについて、 $A_i = \{ n \in \text{自然数} \mid P_{ii}^{(n)} > 0 \}$ とします。</li>
                <li>任意のiについて、$A_i$の要素の最大公約数が1ならばマルコフ連鎖は非周期性を満たします。</li>
                <li>つまり、元に戻ってくるステップ数がある周期に縛られません。</li>
            </ul>
            
            <h3>使用する定理</h3>
            <ul>
                <li><strong>命題 1.7.1.</strong> 次の条件 (1)-(3) は同値です。
                    <ol>
                        <li>マルコフ連鎖はエルゴード的である。</li>
                        <li>マルコフ連鎖は斉時性を満たし、既約で、すべての状態は非周期的である。</li>
                        <li>マルコフ連鎖は斉時性を満たし、既約で、非周期的な状態が存在する。</li>
                    </ol>
                </li>
                <li><strong>定理 1.7.2.</strong> マルコフ連鎖がエルゴード的であるとき、定常分布 $\pi = \{\pi_j\}_{j \in S}$ が一意に存在し、次を満たします:<br>
                ある定数 $C > 0$ と $\gamma \in (0,1), n_0 \in \mathbb{N}$ が存在し、
                    $$ |p_{ij}^{(n)} - \pi_j| \le C \gamma^n, \quad i,j \in S, n \ge n_0 $$
                従って、このとき特に、$\lim_{n \to \infty} p_{ij}^{(n)} = \pi_j, \quad i,j \in S$ が成り立ちます。
                </li>
                <li>つまりマルコフ連鎖が有限、既約かつ斉時性、非周期性を満たすならば定常分布は唯一に定まります！</li>
                <li>エルゴード性は定常分布の一意性を示しています。これは定常分布の存在条件ではありません。</li>
            </ul>

            <h3>焼きなまし法の定式化</h3>
            <ul>
                <li>焼きなまし法のアルゴリズムがどのように定式化できるか見ていきましょう。</li>
                <li>焼きなまし法を以下のようにモデル化します。</li>
                <li>ある温度Tの時、$P_{ij} = G_{ij} \cdot A_{ij}(T)$ とします。(Pijはiからjへの遷移確率)</li>
                <li>$G_{ij}$ はiからjへの遷移確率です。</li>
                <li>$A_{ij}(T) = \min(1, \exp((E_i - E_j)/T))$ とします。</li>
                <li>ここでEi, Ejは状態i, jでの目的関数値(TSPならば経路の長さに相当)です。</li>
                <li>つまりGijで遷移先の頂点をjと決め、$A_{ij}(T)$で実際に遷移するかとどまるかを選択しています。</li>
                <li>Ei &lt;= Ejなら温度に関係なく遷移するが、Ei > Ejの時温度が下がるほど受理確率が低くなるというのは焼きなまし法のアイデアをうまく反映できています。</li>
            </ul>

            <h3>ギブス分布と詳細つり合い条件</h3>
            <ul>
                <li>ここでギブス分布というものを考えます。</li>
                <li>状態sの温度Tの時、以下のように$\pi(s)$を定義します。
                    $$ \pi(s) = \frac{1}{Z(T)} \exp\left(-\frac{E(s)}{T}\right) $$
                    $$ Z(T) = \sum_{x \in \Omega} \exp\left(-\frac{E(x)}{T}\right) $$
                </li>
                <li>※E(s): 状態sでのコスト(TSPなら総移動距離)、$\Omega$は状態集合全体。</li>
                <li>また定常状態が存在する十分条件についても述べておきます。</li>
                <li>任意の二状態i, jに対し、$\pi(i)P_{ij} = \pi(j)P_{ji}$ を満たします。</li>
                <li>つまり任意の二状態間の流量が釣り合っています。</li>
                <li>次でギブス分布が定常状態の分布となる証明をします。</li>
            </ul>

            <h3>証明</h3>
            <h4>証明(1)</h4>
            <p>
                $\pi(i)P_{ij} = \pi(j)P_{ji}, \quad P_{ij} = G_{ij} A_{ij}(T)$<br>
                一般的な探索手法では$G_{ij} = G_{ji}$であるため、
                $$ \frac{A_{ij}}{A_{ji}} = \frac{\pi(j)}{\pi(i)} $$
                $\pi(\cdot)$にギブス分布の式を代入すると
                $$ \frac{\pi(j)}{\pi(i)} = \frac{\exp(-E(j)/T)}{\exp(-E(i)/T)} = \exp\left(-\frac{E(j)-E(i)}{T}\right) $$
                ここで遷移の受理確率 $A_{ij}(T) = \min(1, \exp(-(E_j - E_i)/T))$ を思い出してみましょう。
            </p>
            
            <h4>証明(2)</h4>
            <ul>
                <li><strong>Case 1: $E(j) \le E(i)$ (解が改善する場合)</strong>
                    $$ A_{ij} = 1 $$
                    $$ A_{ji} = \exp\left(-\frac{E(i)-E(j)}{T}\right) = \exp\left(\frac{E(j)-E(i)}{T}\right) $$
                    $$ \frac{A_{ij}}{A_{ji}} = \exp\left(-\frac{E(j)-E(i)}{T}\right) $$
                </li>
                <li><strong>Case 2: $E(j) > E(i)$ (解が悪化する場合)</strong>
                    $$ A_{ji} = 1 $$
                    $$ A_{ij} = \exp\left(-\frac{E(j)-E(i)}{T}\right) $$
                    $$ \frac{A_{ij}}{A_{ji}} = \exp\left(-\frac{E(j)-E(i)}{T}\right) $$
                </li>
            </ul>
            <p>
                どちらのケースでも $\frac{A_{ij}}{A_{ji}}$ と $\frac{\pi(j)}{\pi(i)}$ が一致します。<br>
                →つまりギブス分布は定常分布の候補の一つであることが示されました！
            </p>

            <h3>証明の成果</h3>
            <ul>
                <li>焼きなまし法が既約、非周期性、斉時性、有限性を満たすことは次から明らかです。</li>
                <li>理論的な解説は温度Tを固定して行います。遷移確率は状態と固定された温度のみに依存し、時間ステップにはよらないため斉時的です。</li>
                <li>焼きなまし法は、組合せ最適化問題を主対象とします。これらの問題では、解の組み合わせ、すなわち状態空間は有限です。</li>
                <li>近傍探索は、どんな解からでも他の全ての解へ到達できるよう設計されます。受理確率はゼロにならないため、生成された候補への遷移は常に可能であり、既約性が保証されます。</li>
                <li>生成された候補への遷移が受理されず、現在の状態に留まる確率は常に正です。ある状態に1ステップで留まることができれば、その状態の周期は1となり、非周期性が満たされます。</li>
                <li>エルゴード性を満たすことより、ギブス分布 = 定常分布が示されました！</li>
            </ul>

            <h3>温度Tが0に漸近すると...</h3>
            $$
            \lim_{x \to +0} e^{a/x} = 
            \begin{cases}
                \infty & (\text{if } a > 0) \\
                1 & (\text{if } a = 0) \\
                0 & (\text{if } a < 0)
            \end{cases}
            $$
            <p>
                状態sの定常分布 $\pi_T(s) = \frac{1}{Z(T)} \exp(-\frac{E(s)}{T})$ を考えます。
                s'を状態集合の中の最適解の要素だとすると、
                $$
                \lim_{T \to +0} \pi(s) = \lim_{T \to +0} \frac{\exp(-\frac{E(s)}{T})}{\sum_{x\in\Omega} \exp(-\frac{E(x)}{T})}
                = \lim_{T \to +0} \frac{\exp(\frac{E(s') - E(s)}{T})}{\sum_{x\in\Omega} \exp(\frac{E(s') - E(x)}{T})}
                $$
                $\{x'\}$を最適状態の集合とすると、
                $$
                \lim_{T \to +0} \pi(s) =
                \begin{cases}
                    \frac{1}{|\{x'\}|} & (\forall s \in \{x'\}) \\
                    0 & (\forall s \notin \{x'\})
                \end{cases}
                $$
                ※$|\{x'\}|$ は最適状態の数です。
            </p>

            <h3>温度Tが0に漸近すると... (結論)</h3>
            <ul>
                <li>先ほどの証明から、定常分布がギブス分布で与えられるとき、温度を0に近づけた極限における定常分布は真の最適解だけからなる一様分布になることが示されました。</li>
                <li>これらの証明から何が言えるのでしょうか。</li>
                <li>温度Tを十分にゆっくり下げることで常に状態が平衡状態を保ちながら最終的に最適解へ到達することができます (理論上最適解を出せるという面では少しA*アルゴリズムと似ています)。</li>
                <li>k回目のアニーリングの温度をTkとする。$T_k = T_1 / (\log k)$と設定すれば、焼きなまし法は最適状態に到達できることが確率的に保証されていますが今回は触れません。</li>
            </ul>

            <h3>実際の応用</h3>
            <ul>
                <li>しかし一般に十分ゆっくり冷却すると時間がかかりすぎるため、基本的には指数冷却が用いられます。
                    $$ T_{k+1} = \gamma T_k \quad (0 \le \gamma < 1) $$
                </li>
                <li>焼きなまし法は汎用性を持つが、それゆえパラメータを問題に対してチューニングする必要があり、主に6つのパラメータを設定する必要がある。
                    <ul>
                        <li>最高温度(初期温度)</li>
                        <li>最低温度(終了温度)</li>
                        <li>冷却周期(1つの温度での繰り返し回数)</li>
                        <li>冷却回数</li>
                        <li>冷却率($\gamma$)</li>
                        <li>総探索回数</li>
                    </ul>
                </li>
            </ul>

            <h3>2-opt</h3>
            <ul>
                <li>パス上でi番目の頂点とj番目の頂点について考え、$d(i,j)$を頂点間の距離とします。</li>
                <li>この時、解が改良方向に進むには以下の条件を満たしている必要があります。
                    $$ d(i,j) + d(i+1, j+1) < d(i, i+1) + d(j, j+1) $$
                </li>
            </ul>
        </article>

        <a href="index.html" class="back-link">&laquo; 記事一覧に戻る</a>
    </main>

    <footer>
        <p>&copy; 2025 climaxのホームページ</p>
    </footer>
</body>
</html>